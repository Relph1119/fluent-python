# 第25章 杂谈汇总

## 第1章 杂谈

- 数据模式还是对象模式：
    - 对象模式（维基百科）：一门计算机编程语言中对象的一般特性。
    - 本书采用数据模型，因为Python文档始终使用这个词指代Python对象模型。

- 麻瓜方法：Python和Ruby都利用了魔法方法这个概念丰富元对象协议。

- 元对象：《The Art of the Metaobject Protocol》这本书的元对象协议对理解Python数据模型有帮助，一套丰富的元对象协议能够让我们扩展语言，支持新的编程范式。

## 第2章 杂谈

- 元组的本质：ABC语言的compound类型是Python元组的前身。该类型还支持并行复制，也可用作字典的组合键。但是不是序列，不可迭代，不饿能通过索引获取字段，不能使用切片。

- 扁平序列与容器序列：
    - 扁平序列：是不可嵌套的序列类型，只能包含简单的原子类型，例如整数、浮点数或字符。
    - 容器序列：可以嵌套，包含任何类型的对象，甚至是容器类型自身。

- 大杂烩列表：
    - 如果列表中的项不可比较，就不能排序。
    - 如果元组中的每一项都是一个字段，那么每个字段就可以具有不同的类型。

- 聪明的`key`：
    - 只需要定义一个单参数函数，通过它获取或计算用于排序对象的标准即可。
    - 高效：key指定的函数只在处理各项时调用一次，而双参数比较函数在每次需要通过排序算法比较两项时，都需要调用一次。

- 甲骨文、谷歌和Timbot阴谋论：
    - `Oracle`和`list.sort`使用的排序算法是`Timsort`，一种自适应算法，可根据数据的排序方法在插入排序法和归并排序法之间切换。
    - `Timsort`于2002年首次在CPython使用。
    - `Timsort`由Tim Peters发明，称为`Timbot`。

## 第3章 杂谈

- 语法糖：
    - Alan Perlis（首届图灵奖的获得者）：语法糖诱发分号癌。
    - Python简单又正确，JSON与Python几乎完全兼容。

## 第4章 杂谈

在源码中应该使用非ASCII名称吗？
    
- Python3允许在源码中使用非ASCII标识符。
- 让每个人都能轻松地阅读和编辑代码，需要分情况：
    - 如果在一家跨国企业，或者一个开源项目中，标识符推荐使用英语，也要使用ASCII字符。
    - 如果是一名教师，可以使用本地化语言进行变量和函数命名。
- 任何人都应该选择让团队成员更容易理解代码的语言，并使用正确的字符拼写。  

## 第5章 杂谈

- Python一直都有声明类属性的简便方式，实例属性更常用，直接在`__init__`方法中创建实例属性。
- @dataclass解决了上述问题，类型提示始终是可选的。

## 第6章 杂谈

- 平等对待所有对象：Python采用的方式是`==`运算符比较对象的值，而`is`比较引用。
- 可变性：在Python中，用户定义的类，实例默认可变。
- 对象析构和垃圾回收：CPython的垃圾回收主要依靠引用计数，在CPython2.0实现了分代垃圾回收机制，把引用循环中不可达的对象销毁。
- 参数传递（共享传参）：
    - 在早期的语言中，参数传递模式有按值传递（函数得到实参的副本）和按引用传递（函数得到实参的指针）。
    - 在Python中，函数得到实参的副本，但是实参始终是引用的。

## 第7章 杂谈

- Python是一门函数式语言吗？
    - Guido var Rossum（Python之父）：Python中一切好的功能都是从其他语言中借鉴来的。
    - Python提供一等函数，打开了函数式编程的大门。
    - `map`、`filter`和`reduce`最初目的是为Python增加lambda表达式。
    - 影响Python函数式编程惯用法的原因是缺少尾调用消除（通过末尾递归调用，提高计算函数的内存使用效率）。
    - 从设计上，不管函数式语言的定义如何，Python都不是一门函数式语言，只是从函数式语言中借鉴了一些好的想法。

- 匿名函数的问题：匿名函数嵌套的层级太深，不利于调试和处理错误。

## 第8章 杂谈

类型的认知效应：
- 强版本认为，语言决定思维，语系限制并决定认知范畴。
- 弱版本认为，语系和用法只影响思维和决策。
- 语言相对论可以解释，学习不同的编程语言，尤其是支持不同编程范式的语言，能让你成为更好的程序员。

## 第9章 杂谈

- 动态作用域与词法作用域：
    - 动态作用域：根据调用函数的环境求解自由变量。
    - 如果函数使用自由变量，程序员必须知道函数的内部细节，才能建立正确运行所需的环境。
    - 词法作用域：根据定义函数的环境求解自由变量。
    - 在JavaScript中，特殊变量this既可以使用词法作用域，也可以使用动态作用域。

- Python装饰器和装饰器设计模式：
    - Python函数装饰器符合对装饰器模式的一般描述：动态地给一个对象添加一些额外的职责，就扩展功能而言，装饰器模式比子类化更灵活。
    - 在实现层面，Python装饰器与装饰器设计模式不同，装饰器函数相当于Decorator的具体子类，而装饰器返回的内部函数相当于装饰器实例。

## 第10章 杂谈

- Python拥有一等函数和一等类型。
- 设计模式与语言功能无法精确对应。
- 并不意味着所有模式都能一成不变地在任何语言中使用，一些特殊的面向对象语言可以直接支持我们的某些模式。

## 第11章 杂谈

特性有助于减少前期投入：

- 先用公开属性的方式定义类，如果以后需要对读值方法和设值方法增加控制，可以通过特性实现，对一开始通过公开属性的名称与对象交互的代码没有影响。
- Java语言不能这样做，需要前期就编写读值方法和设值方法。

## 第12章 杂谈

- 把协议当作非正式接口：
    - 模仿内置类型实现类时，记住一点：模仿的程度对建模的对象来说合理即可。
    - 不要为了满足过度设计的接口契约以及让编译器开心而去实现不需要的方法，要遵守KISS原则。

> KISS 原则是 "Keep It Simple, Stupid" 的缩写，翻译为 "保持简单，傻瓜"。它是一种设计和开发原则，强调在解决问题或开发产品时保持简单性和直观性的重要性。  
> KISS 原则的核心思想是，简单的解决方案通常比复杂的解决方案更可靠、更易于理解和维护。它鼓励避免不必要的复杂性、冗余和过度设计，以减少错误和问题的潜在来源。  
> 以下是 KISS 原则的一些关键要点：
> 1. 简洁性：尽量使用简单明了的方法来解决问题，避免过度复杂化。
> 2. 直观性：使设计和实现易于理解和使用，避免引入混乱和困惑的元素。
> 3. 避免冗余：消除不必要的重复和冗余代码、功能或设计。
> 4. 最小化依赖：减少依赖关系和复杂的依赖链，以降低系统的脆弱性。
> 5. 高效性：追求高效的解决方案，避免不必要的计算或资源浪费。

- 鸭子类型的起源：在面向对象编程中较早使用鸭子做比喻的人是Alex Martelli，出现在他于2000年7月26日发到Oython-list中一条消息，即“polymorphism (was Re: Type checking in python?)”。

- 安全的`__format__`方法，增强可用性：该方法用于向终端用户显示输出，使用`reprlib`截断超出的部分，使用`...`表示。

寻找符合Python风格的求和方式：
- 起因：由于一篇2003年4月的文章，Guy Middletion不喜欢用lambda表达式处理求和方式。
- 讨论：用operator.add方式代替lambda表达式。
- 建议：Alex Martelli给出建议并实现了`sum()`函数，Python2.3内置了这个函数，Python2.4引入了生成器表达式。
- 进一步讨论：Alex Martelli指出，Python2内置的`reduce`函数“成事不足败事有余”，它推荐的地道编程方式难以理解。
- 结论：Python3把`reduce`函数移到了`functools`模块中。

## 第13章 杂谈

Python静态类型的MVP之旅

- MVP（Minimal Viable Product）：最简可用产品。
- Python3.0针对静态类型提供了非常有限的语义，只有为函数的参数和返回值附加注解的语法。
- Python3.5中增加了标准库中其他部分未依赖的`typing`模块。
- PEP484-Type Hints提出并获得批准，支持具有泛型的名义类型，把具体的静态检查工作交给外部工具。这个工具吸引了专业的IDE提供支持。

流行语言实现类型的方式：
- 鸭子类型：Python、TypeScript、JavaScript、Smalltalk。
- 大鹅类型：Python>=2.6、TypeScript、Go。
- 静态鸭子类型：Python>=3.8、TypeScript、Go。
- 静态类型：Python>=3.5、TypeScript、Go、Java。

猴子补丁：如果滥用，则会导致系统难以理解和维护。补丁通常于目标紧密耦合，很脆弱。

## 第14章 杂谈

- 如果发现自己在构建多层类的层次结构，可能发生了以下事件：
    - 在重新发明轮子。去寻找框架或库，看看它们提供的组件是否可以在应用程序中复用。
    - 使用的框架设计不良，去寻找替代品。
    - 过度设计，需要遵守KISS原则。
    - 创造一个新框架。

- 内置类型dict、list和str是Python的底层基础，Cpython为了执行速度，不调用被子类覆盖的方法。

- 通过UserDict、UserList和UserString，可以加强扩展。

- 术语“面向对象”是Alan Kay发明的，而Smalltalk只支持单一继承。

- C++是第一门实现多重继承的流行语言。

## 第15章 杂谈

- 类型无底洞：使用类型检查工具，有时迫不得已要导入不需要知道的类，除了编写类型提示外，这些类在代码中根本用不到，也没有文档记录。
- 其他语言的型变表示法：
    - 协变或逆变不是类型变量的性质，而是使用类型变量定义的泛化类的性质。
    - 在Python中的类型变量应该仿照Kotlin和C#，使用out修饰符表示T是一种输出类型，使用in修饰符表示T是一种输入类型。

## 第16章 杂谈

运算符重载的优缺点讨论：
- James Gosling（Java之父）：世界上有成千上万个运算符，只有少数几个适合重载。决定不让Java支持运算符重载。
- Guido van Rossum（Python之父）：不放任用户随意创建像`<=>`或`:)`这样新的运算符，这样禁止了用户对运算符的异想天开，而且能让Python解析器保持简单。社区中约有10%的人能正确地使用和真正关心运算符重载。
- 作者：重载的运算符，如果使用得当，的确能让代码更易于阅读和编写。

## 第17章 杂谈

Python中极简的迭代器接口：使用`__next__`方法完成迭代器的组合。

可插拔的生成器：
- 需求：把CDS/ISIS文件转换成适合导入CouchDB或MongoDB的JSON文件。
- 演变：
    1. 第1版：使用CDS/ISIS导出的ISO-2709格式读取文件，采用渐进方式。
    2. 第1版问题：需要让脚本支持另一种数据格式（.mst文件），脚本需要接受多个命令行选项，用于调整输出的记录结构。
    3. 第2版：隔离读取逻辑，将其写进一对生成器函数中，一个函数支持一种输入格式。
- 总结：用生成器函数解耦了读逻辑和写逻辑，使用生成器，可以交叉读写，处理任意大小的文件。
- 扩展：如果需要再支持一种输入格式，只需要再添加一个生成器函数来实现读逻辑即可。

## 第18章 杂谈

- 真尾调用：通过递归迭代替代命令式语言中的while循环。
- 尾调用：一个函数返回一个函数（可以是同一个函数，也可以不是）调用的结果。
- 对于支持真尾调用的语言，解释器遇到尾调用时，会跳入被调用函数的主体，不创建新的栈帧，可以节省内存。
- Guido van Rossum和其他人的评论：真尾调用提高了所有人的调试难度，只有少数坚持使用递归进行迭代的人能从中受益。

## 第19章 杂谈

线程和锁模式的不受约束性：
- 线程可以共享访问任意可变的数据结构。
- 调度程序几乎可以在任何时刻中断线程。
- 锁往往是建议性的，在更新共享的数据结构之前，必须显式持有锁。

参与者模式的约束性：
- 参与者可以有内部状态，但是不能与其它参与者分享状态。
- 参与者之间通过收发消息进行通信。
- 消息中只能存有数据的副本，不能引用可变的数据。
- 一个参与者一次只处理一个消息。对于单个参与者，没有并发执行的概念。

## 第20章 杂谈

- 并发是计算机科学中最难的概念之一（通常最好别去招惹它）。
- 千万不要自己管理线程和锁。
- `concurrent.future`包，把线程、进程和队列视作服务的基础设施，不用自己动手直接处理。

## 第21章 杂谈

uvloop的基准测试：
- 2016年，Yury Selivanov发布了uvloop，需要配置Go语言使用单个线程，使用httptools。
- 使用aiohttp对uvloop进行了基准测试之后，编写httptools。理由是HTTP解析器的速度太慢了。
- HTTP性能测试用到了一个简单的回显服务器，HTTP首部解析是CPU密集型操作，使用Python编写的函数解析首部，导致事件循环受到阻塞。因此优化httptools库。

系统性能诊断：
- 背景：系统使用Python2.7编写，使用Twisted框架，属于asyncio的前身。
- 问题：每增加一个功能，有更多CPU密集型代码拖慢Twisted的事件循环。
- 解决思路：重新思考系统架构，重写大量代码，也行需要任务队列，可能还要使用微服务，或者以更适合并发处理CPU密集型操作的语言编写库。
- 结论：项目方不准备继续投资了，项目被取消了。

## 第22章 杂谈

讨论统一访问原则：
- 在面向对象编程语言中，是否遵守统一访问原则通常体现在句法上：究竟时读取公开的数据属性，还是调用读值和设值方法。
- Smalltalk和Ruby语言，根本不支持公开的数据属性。所有实例属性都是私有的，必须通过方法来存取。
- Java让程序员在4种访问级别修饰符中选择。

类与函数：
- Python还有一处体现了统一访问原则，函数调用和对象实例化使用相同的句法。
- 构造方法替换成工厂函数的理由：
    1. 通过返回之前构建的实例，限制实例的数量。
    2. 缓存构建过程开销大的对象。
- 构造工厂方法，API的设计者必须提前决定。

## 第23章 杂谈

`self`的设计：
- 设计方法必须简单，对实现和接口来说都是如此。简单的实现比简单的接口更重要。简单是设计过程中最重要的考虑因素。
- 这种做法最初是由Modula-3语言提供。
- 除了要明确把self作为参数，限制必须通过self方法实例属性也备受批评。
- 如果讨厌Python要求显式使用self，想想JavaScript中隐式this那变幻莫测的语义，这样就感觉好多了。

## 第24章 杂谈

计算机科学的教学方法分为两个流派：
1. 保守派：计算机程序已经变得极其大而复杂，超过了人类思维所能承载的限度。因此，计算机科学教育的任务是**训练平庸的程序员**，这样500个人合作便能开发出恰好满足需求的程序。
2. 激进派：计算机程序已经变得极其大而复杂，超过了人类思维所能承载的限度。因此，计算机科学教育的任务是**教人如何拓展思维，打破常规，学习以更广博、更强大和更灵活的方式思考，让思维超越程序**。编程思想的各个方面在程序中必会得到充分体现。

编程语言的激进：
- Java一开始使用的就是存取方法，编写程序时，可以先把属性设为公开的（遵循KISS原则），公开的属性无需大幅改动，随时都能变成特性。
- 把函数当作一等对象，描述符和高阶函数合在一起思想，使得函数和方法的统一成为可能。
- Python中的类也是一等对象，提供类构建器、类装饰器、以及允许用户定义功能完整的元类。
